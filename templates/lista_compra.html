<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Lista de Compras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <style>
        .suggestion { cursor: pointer; padding: 10px; border-bottom: 1px solid #eee; }
        .suggestion:hover { background: #f8f9fa; }
        .suggestion .precio { font-weight: bold; color: #0d6efd; }
        .suggestion .super { font-size: 0.85em; color: #666; }
    </style>
</head>
<body class="bg-light">
<div class="container py-5">
    <h1 class="mb-4">Lista de la Compra</h1>

    <!-- Crear o seleccionar lista -->
    <div class="card mb-4">
        <div class="card-body">
            <form hx-post="{{ url_for('crear_lista') }}" hx-target="#lista-container" hx-swap="innerHTML">
                <div class="row g-3 align-items-end">
                    <div class="col-auto flex-grow-1">
                        <input type="text" name="nombre" class="form-control" placeholder="Nombre de la nueva lista (ej: Semanal Carrefour)" required>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-success">Crear Nueva Lista</button>
                    </div>
                </div>
            </form>

            {% if listas %}
            <hr>
            <h6>O abrir una existente:</h6>
            <div class="d-flex flex-wrap gap-2">
                {% for lista in listas %}
                <a href="{{ url_for('ver_lista', lista_id=lista.id) }}" class="btn btn-outline-primary btn-sm">
                    {{ lista.nombre }} ({{ lista.fecha_creacion }})
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Contenedor de la lista activa -->
    <div id="lista-container">
        {% if lista_activa %}
            {% include "partials/lista_activa.html" %}
        {% else %}
            <div class="alert alert-info text-center">
                Crea una lista o selecciona una existente para empezar
            </div>
        {% endif %}
    </div>
</div>

{% if lista_activa %}
<script>
// Esta función es GLOBAL y debe estar aquí para que htmx la vea siempre
window.seleccionarProducto = function(id, nombre, precio, supermercado) {
    console.log("Producto seleccionado →", id, nombre, precio, supermercado);

    // Rellenar el input oculto
    const inputId = document.getElementById('producto_id');
    if (inputId) inputId.value = id;

    // Mostrar qué producto seleccionaste
    const display = document.getElementById('nombre_display');
    if (display) {
        if (precio && precio > 0) {
            display.innerHTML = `<strong>${nombre}</strong> → <span class="text-success fw-bold">$${parseFloat(precio).toFixed(2)}</span> en <em>${supermercado}</em>`;
        } else {
            display.innerHTML = `<strong>${nombre}</strong> <span class="text-muted">(sin precio)</span>`;
        }
    }

    // Cerrar el autocompletado
    const suggestions = document.querySelector('.autocomplete-suggestions');
    if (suggestions) suggestions.innerHTML = '';

    // Poner foco en cantidad
    const cantidadInput = document.getElementById('cantidad');
    if (cantidadInput) {
        cantidadInput.focus();
        cantidadInput.select();
    }
};
</script>
{% endif %}
</body>
</html>